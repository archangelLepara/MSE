// ðŸ”¹ Firebase imports (MODULAR v9)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot } 
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ðŸ”¹ Your Firebase config (UNCHANGED)
const firebaseConfig = {
  apiKey: "AIzaSyD99DgDdJgdFnGAynKMgGABLslPaMnnxQs",
  authDomain: "mse-portfolio-tracker.firebaseapp.com",
  projectId: "mse-portfolio-tracker",
  storageBucket: "mse-portfolio-tracker.firebasestorage.app",
  messagingSenderId: "559959273122",
  appId: "1:559959273122:web:0c799c6a426f5fe1b6b1fb",
  measurementId: "G-TT09TSVQRS"
};

// ðŸ”¹ Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ðŸ”¹ Globals
let currentUser = null;
let chart = null;

// ðŸ” Login
document.getElementById("loginBtn").onclick = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

// ðŸšª Logout
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
};

// ðŸ‘¤ Auth state listener
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById("user").innerText =
      `Logged in as ${user.email}`;
    loadStocks();
  } else {
    currentUser = null;
    document.getElementById("user").innerText =
      "Not logged in";
  }
});

// ðŸ’¾ Save stock
document.getElementById("saveStock").onclick = async () => {
  if (!currentUser) {
    alert("Login first");
    return;
  }

  const stock = document.getElementById("stock").value;
  const shares = Number(document.getElementById("shares").value);
  const price = Number(document.getElementById("price").value);

  await addDoc(
    collection(db, "users", currentUser.uid, "stocks"),
    { stock, shares, price }
  );
};

// ðŸ“Š Load stocks & draw chart
function loadStocks() {
  const ref = collection(db, "users", currentUser.uid, "stocks");

  onSnapshot(ref, snapshot => {
    const labels = [];
    const values = [];

    snapshot.forEach(doc => {
      const d = doc.data();
      labels.push(d.stock);
      values.push(d.shares * d.price);
    });

    drawChart(labels, values);
  });
}

// ðŸ“ˆ Chart.js
function drawChart(labels, data) {
  const ctx = document.getElementById("chart");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Portfolio Value",
        data
      }]
    }
  });
}
